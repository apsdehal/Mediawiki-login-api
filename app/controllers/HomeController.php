<?php

 class HomeController{

 	/**
 	 * @var $mwConfig A variable for holding an instance of MWOAuthClientCOnfig
 	 * @var $cmrToken Token received generated by passing secret and consume_token to
 	 * 					to OAuthClient class
 	 * @var $client Instance of MWOAuthClass that is generated after passing both above vars into it
 	 * 				Used to interact with Wikimedia's OAuth API 	
 	 */	
 	// private $mwConfig, $cmrToken, $client;
 	private $mwClient;

 	/**
 	 * Function to handle the get request made to the server where this app reside
 	 * Since the App is built in a RESTful manner thats why this function is here
 	 * Initiaites the client and makes the redirect to and fro the wikimedia OAuth clientS
 	 * Also return the user info, <= todo after testing
 	 */	
 	public function get(){
 		$this->mwClient = new MW_OAuth(	'Wikidata-Annotation', 'wikidata', 'www' );
 		$this->getUserInfo();

 		switch ( isset( $_GET['action'] ) ? $_GET['action'] : '' ) {
			case 'download':
				header( 'Content-Type: text/plain' );
				readfile( __FILE__ );
				return;

			case 'authorize':
				$this->mwClient->doAuthorizationRedirect();
				return;
			case: 'getCurrentInfo':
				$this->getCurrentInfo();
			case: 'logout':
				$this->logout();		
			case 'userinfo':
				$this->getUserInfo();	

		}

		echo "hello";
 	}

 	public function getUserInfo(){

 		if(isset($_COOKIE['authDone']) && $_COOKIE['authDone'] == true){
 			$_SESSION['authDone'] = true;
 		}

 		if( isset($_SESSION['authDone']) && $_SESSION['authDone'] == true ){
 			$postData = array(
 				'action' => 'query',
 				'meta' => 'userinfo',
 				'uiprop' => 'email|editcount|realname',
 				'format' =>'json'
 				);
 			$name = $queryResults->query->userinfo->name;
 			$queryResults = $this->mwClient->doApiQuery($postData);
 			$info = array(
 				"loginStatus" => 1,
 				"id" => $queryResults->query->userinfo->id,
 				"fullName" => $name,
 				"firstName" => $name,
 				"lastName" => "",
 				"email" => "",
 				"uri" => "https://www.mediawiki.org/wiki/User:" . $name,
 				"openid" => "",
 				"loginServer" => "http://tools.wmflabs.org/wikidata-annotation-tool?action=authorize",
 				)
 			$user = new User($info);
 			echo $user->getInfo();
 		}
 	}
 
 }